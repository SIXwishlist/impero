{% embed 'Pckg/Generic/View/modal.twig' with {'close': true, 'id': 'attributesModal'} %}
    {% block header %}
        Change attributes
    {% endblock %}
    {% block body %}
        <p v-if="loading.attributes">Loading attributes ...</p>
        {{ attributesForm | raw }}
        <br/>
        <br/>
        <h2>Grouped orders ({{ similarOrders.length }})</h2>
        {% verbatim %}
        <p v-if="loading.similarOrders">Loading similar orders ...</p>
        <table v-if="similarOrders.length" class="table table-condensed table-hover table-striped">
            <tr><th>number (id)</th><th>payee</th><th>packets</th><th></th></tr>
            <tr v-for="order in similarOrders" track-by="id">
                <td>{{ order.num }} ({{ order.id }})</td>
                <td>{{ order.user.name }} {{ order.user.surname }}<br />{{ order.user.email }}</td>
                <td>
                    {{ order.packetsSummary }}
                </td>
                <td>
                    <a href="#" v-on:click.prevent="remove(order)" class="btn btn-danger btn-sm">Remove</a>
                </td>
            </tr>
        </table>
        <h2>Non-allocated orders ({{ nonAllocatedOrders.length }})<input type="text" v-model="nonAllocatedSearch" /></h2>
        <p v-if="loading.nonAllocatedOrders">Loading non-allocated orders ...</p>
        <table v-if="nonAllocatedOrders.length" class="table table-condensed table-hover table-striped">
            <tr><th>number (id)</th><th>payee</th><th>packets</th><th></th></tr>
            <tr v-for="order in nonAllocatedOrders | filterBy nonAllocatedSearch" track-by="id">
                <td>{{ order.num }} ({{ order.id }})</td>
                <td>{{ order.user.name }} {{ order.user.surname }}<br />{{ order.user.email }}</td>
                <td>
                    {{ order.packetsSummary }}
                </td>
                <td>
                    <a href="#" v-on:click.prevent="add(order)" class="btn btn-success btn-sm">Add</a>
                </td>
            </tr>
        </table>
        {% endverbatim %}
    {% endblock %}
{% endembed %}

<script type="text/javascript">
    new Vue({
        parent: maestroTable,
        el: '#attributesModal',
        data: function () {
            return {
                similarOrders: [],
                nonAllocatedOrders: [],

                appartment: null,
                checkin: null,
                people: null,

                nonAllocatedSearch: null,

                loading: {
                    nonAllocatedOrders: false,
                    similarOrders: false,
                    attributes: false
                }
            };
        },
        methods: {
            openAttributesPopup: function (id) {
                this.appartment = id;

                this.fetchAttributes('/dev.php/orders/allocation/attributes/' + id);

                $('#attributesModal').modal('show');
            },

            fetchAppartmentData: function () {
                this.fetchSimilarOrders();
                if (this.nonAllocatedOrders.length == 0)
                    this.fetchNonAllocatedOrders();
            },

            fetchAttributes: function (url) {
                this.loading.nonAllocatedOrders = true;
                this.loading.similarOrders = true;
                this.loading.attributes = true;

                http.getJSON(url, function (data) {
                    this.appartment = data.appartment;
                    this.checkin = data.checkin;
                    this.people = data.people;
                    this.loading.attributes = false;
                    this.fetchAppartmentData();
                }.bind(this));
            },

            fetchNonAllocatedOrders: function () {
                this.loading.nonAllocatedOrders = true;
                http.getJSON('/dev.php/orders/allocation/non-allocated', function (data) {
                    this.loading.nonAllocatedOrders = false;
                    this.nonAllocatedOrders = data.nonAllocatedOrders;
                }.bind(this));
            },

            fetchSimilarOrders: function () {
                this.loading.similarOrders = true;
                http.post('/dev.php/orders/allocation/similar', {
                    appartment: this.appartment
                }, function (data) {
                    this.loading.similarOrders = false;
                    this.similarOrders = data.similarOrders;
                }.bind(this));
            },

            saveAppartment: function () {
                http.post('/dev.php/orders/allocation/save', {
                    appartment: this.appartment,
                    checkin: this.checkin,
                    people: this.people,
                    orders: this.similarOrders.map(function (order) {
                        return order.id;
                    }),
                }, function () {

                });
            },

            remove: function (order) {
                this.nonAllocatedOrders.push(order);
                this.similarOrders.$remove(order);
            },

            add: function (order) {
                this.similarOrders.push(order);
                this.nonAllocatedOrders.$remove(order);
            }
        }
    }).$on('record:openAttributesPopup', function (id) {
        this.openAttributesPopup(id);

        return true;
    });
</script>